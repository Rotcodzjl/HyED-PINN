import matplotlib.pyplot as plt
import scienceplots
plt.style.use(['science', 'nature'])
import pandas as pd
import seaborn as sns
from matplotlib.backends.backend_pdf import PdfPages
import matplotlib.ticker as mtick
from matplotlib.ticker import MaxNLocator
from matplotlib.lines import Line2D
import numpy as np  # Added for stable legend creation

def plot_error_violins(data_dict, output_file=None):
    """
    Plot violin plots for error metrics across different datasets and models.

    Parameters:
    - data_dict: Dictionary containing the data in the format:
        {
            'dataset_name': {
                'batches': [batch_numbers],
                'Ours': { batch_number: { 'MAE': [...], 'MAPE': [...], 'RMSE': [...] } },
                'MLP': { same structure },
                'CNN': { same structure },
                'LSTM': { same structure }  # Added LSTM model
            }
        }
    - output_file: Path to save the plot (optional)
    """
    fig, axs = plt.subplots(2, 3, figsize=(2.3 * 3, 1.8 * 2), dpi=200)
    # Added a fourth color for LSTM
    colors = ['#ffadad', '#a0c4ff', '#caffbf', '#ffd6a5']
    count = 0

    for data, dataset_info in data_dict.items():
        batches = dataset_info['batches']
        for batch in batches:
            df_list = []
            for model in ['Ours', 'MLP', 'CNN', 'LSTM']: # Included LSTM here
                if batch not in dataset_info[model]:
                    continue # Skip if this batch doesn't exist for the model
                model_data = dataset_info[model][batch]
                df1 = pd.DataFrame({
                    'MAE': model_data['MAE'],
                    'MAPE': model_data['MAPE'],
                    'RMSE': model_data['RMSE'],
                    'model': [model] * len(model_data['MAE'])
                })

                melted_df1 = pd.melt(df1, id_vars=['model'],
                                   value_vars=['MAE', 'MAPE', 'RMSE'],
                                   var_name='metric', value_name='error')
                df_list.append(melted_df1)

            if data in ['CACLE dataset', 'HUST dataset','Oxford dataset','XJTU batch-1', 'XJTU batch-2','XJTU batch-3']:
                title = data
            else:
                title = data + f' batch {batch+1}'

            df = pd.concat(df_list, axis=0)
            df = df.reset_index()
            df = df.drop('index', axis=1) # Avoid using inplace=True
            df['metric'] = df['metric'].astype('category').cat.codes

            col = count % 3  # Col index for 2 columns
            row = count // 3    # Row index for 2 rows
            print(f"Plotting: {data}, batch={batch}, pos=[{row}, {col}]")
            ax = axs[row, col]
            sns.violinplot(x='metric', y='error', hue='model', data=df,
                           scale='count',
                           inner='point',
                           dodge=True,
                           saturation=1,
                           palette=colors,
                           linewidth=0,
                           ax=ax)

            for i, metric in enumerate(['MAE', 'MAPE', 'RMSE']):
                for model in ['Ours', 'MLP', 'CNN', 'LSTM']: # Included LSTM here
                    sub_df = df[(df['model'] == model) & (df['metric'] == i)]
                    if len(sub_df) > 0: # Check if data exists for this combo
                        model_mean = sub_df['error'].mean()
                        model_std = sub_df['error'].std()
                        offset = 0.27 / len([m for m in ['Ours', 'MLP', 'CNN', 'LSTM'] if m != model]) # Smarter offset
                        # Manually assign positions based on model order
                        pos_map = {'Ours': -offset, 'MLP': -offset/2, 'CNN': offset/2, 'LSTM': offset}
                        # x_pos = i + pos_map.get(model, 0)
                        offset = 0.1   # Adjust offset for four models
                        x_pos=i
                        if model== 'Ours':
                            x_pos = i - 3*offset
                        elif model == 'MLP':
                            x_pos = i - offset
                        elif model == 'CNN':
                            x_pos = i + offset
                        elif model == 'LSTM':
                            x_pos = i + 3* offset
                        print(x_pos)
                        ax.plot([x_pos, x_pos], [model_mean - model_std, model_mean + model_std],
                                color='black', linestyle='-', linewidth=0.5)
                        ax.plot([x_pos - 0.05, x_pos + 0.05], [model_mean, model_mean],
                                color='red', linestyle='-', linewidth=0.6)

            ax.set_xticklabels(['MAE', 'MAPE', 'RMSE'])
            ax.set_xlabel(None)

            def percentage(x, pos):
                if x >= 0.2:
                    return '{:.0f}%'.format(x * 100)
                else:
                    return '{:.1f}%'.format(x * 100)

            ax.yaxis.set_major_formatter(mtick.FuncFormatter(percentage))
            x_min, x_max = ax.get_xlim()
            y_max = ax.get_ylim()[1]
            ax.annotate('(\%)', xy=(x_min, y_max), xytext=(-2, 3),
                        textcoords='offset points', ha='center', fontsize=8)
            ax.yaxis.set_major_locator(MaxNLocator(nbins=4))
            ax.yaxis.set_minor_locator(plt.NullLocator())  # 移除次刻度
            ax.set_title(title)
            ax.set_ylabel("Error")
            ax.get_legend().remove() # Remove duplicate legend from each subplot
            ax.xaxis.set_minor_locator(plt.NullLocator())  # 移除次刻度
            if count >= 6: # Stop after filling the 2x2 grid
                break
            count += 1

        if count >= 6: # Sentinel break for outer loop too
            break

    # Create custom artists for the master legend
    boxs = []
    for c in colors:
        box = plt.Rectangle((0, 0), 1, 1, fc=c)
        boxs.append(box)
    # Use consistent positions for mean/std lines across all plots
    mean_line = Line2D([0], [0], color='red', linestyle='-', linewidth=1)
    std_line = Line2D([0, 0], [0, 1], color='black', linestyle='-', linewidth=1)
    boxs.append(mean_line)
    boxs.append(std_line)

    # Add figure-level legend using the created artists
    legend_labels = ['Ours', 'MLP', 'CNN', 'LSTM', 'Mean', 'Mean ± Std']
    fig.legend(handles=boxs, labels=legend_labels, loc='upper center',
               handlelength=4, handleheight=2.5, fontsize=8, ncol=len(legend_labels))

    plt.tight_layout(rect=[0, 0, 1, 0.91]) # Give space at top for legend
    if output_file:
        plt.savefig(output_file, bbox_inches='tight')
    plt.show()

# Example usage with test data including LSTM
test_data = {
    'CACLE dataset': {
        'batches': [0],
        'Ours': {
            0: {'MAE': [0.003637032031891397, 0.00508988167645598, 0.00517809888799683, 0.0026224435502196558, 0.004078899683016941, 0.0016133719364488327, 0.0033585195703266586, 0.002968125214327822, 0.004167884357675165, 0.00681452615634119, 0.005943494293062684, 0.007618385676194962, 0.003354860290065625, 0.002908271041296749, 0.003515129887033269],
                'MAPE': [0.006001721317251074, 0.007942301875905413, 0.009094636571450437, 0.004252282674554895, 0.005277773297996051, 0.002471180981221651, 0.00467470198752863, 0.0037453702849985573, 0.006260590786096702, 0.010885038229265894, 0.00865901278590022, 0.010218600980273166, 0.005493557360854709, 0.0038047718038148486, 0.006161850792382996],
                'RMSE': [0.00457831032869074, 0.006037270970988242, 0.0064015128405125535, 0.0032111814730237925, 0.004576058098721151, 0.0020016478480092987, 0.003990370985830496, 0.0037086878116088604, 0.004978646211875477, 0.008547013640287097, 0.007580993420721433, 0.01194355006655343, 0.004051103308717507, 0.003390426590198253, 0.004370733910941518]},
        },
        'MLP': {
            0: {'MAE': [0.00962969713431784, 0.01639566264461817, 0.010855455338356825, 0.006705268050441469, 0.0038476827833660247, 0.0076114804905625605, 0.009016767395876259, 0.0058422469423326275, 0.007433071628979518, 0.048951732581558854, 0.054132261529421945, 0.04929710739722576, 0.006214119097207741, 0.006330569951860114, 0.006053342850016777],
                'MAPE': [0.013183622789951752, 0.02225808927423682, 0.015551343514021125, 0.011350508167102692, 0.006359142453747069, 0.011928961561782674, 0.012151487407592825, 0.009022997599573309, 0.010688863952472802, 0.06642834618308, 0.0723575673389224, 0.06904093309144979, 0.009552509783266001, 0.009370335562582781, 0.010504175354277475],
                'RMSE': [0.010871290462204598, 0.017589599054394684, 0.013075057540830621, 0.008182385780117488, 0.006119414703350155, 0.009644565620498898, 0.009931443648140977, 0.008186447072276065, 0.00880023072198164, 0.05045143545439281, 0.05536880775686112, 0.05018232805668516, 0.007737335073142221, 0.007924890320005954, 0.00886074551125225]},
        },
        'CNN': {
            0: {'MAE': [0.010229873175025163, 0.0060104335323602, 0.009345865441957438, 0.006400342287461633, 0.008576751130569807, 0.01741413880402768, 0.009034573533344836, 0.010336959881594707, 0.020089352767459396, 0.030223544905623803, 0.0422560441236319, 0.037000085572296115, 0.004829395070627531, 0.008620429151515879, 0.00702413606604497],
                'MAPE':[0.014355343532279869, 0.010969921271711107, 0.01675729580385325, 0.012157385330077632, 0.013478543351057982, 0.02669557445929778, 0.013169605776590316, 0.01530367523947984, 0.02903458354586804, 0.04271956125201276, 0.06537752557263346, 0.061314412807429296, 0.008236951546744751, 0.012674578394897221, 0.010856916941111535],
                'RMSE':[0.012482493211632575, 0.009411436694779476, 0.011775369787783799, 0.011070118995998779, 0.012588228877793255, 0.03282680850932513, 0.012576248486969177, 0.013266533088573817, 0.03941350151547263, 0.031832113742192664, 0.04668712608312578, 0.04106703582524713, 0.008157496082066154, 0.010295400113932124, 0.00899908535462273]},
        },
        'LSTM': { # New model added
            0: {'MAE': [0.02691197084854782, 0.021216613620294467, 0.028700455596728944, 0.02067289098155515, 0.01711141047023271, 0.021099580106496756, 0.022044643834833063, 0.01868968498350452, 0.016779485277224664, 0.024040090593733198, 0.01946974227091236, 0.023349816957715815, 0.02544748515262246, 0.024219985348053887, 0.02679828794595389],
                'MAPE':[0.03869895554792749, 0.03000201870982207, 0.04130489481812415, 0.03123953589873824, 0.025347159653349924, 0.03071358324345107, 0.033339440483859124, 0.02845883387395203, 0.025053139929244215, 0.03690608698300176, 0.03102736737821469, 0.03326533769261001, 0.03596392031180509, 0.0335037546747892, 0.03739926314573759],
                'RMSE':[0.03580734784507018, 0.027614283747629358, 0.03529829329992449, 0.02602799306357777, 0.022110325363975114, 0.026323400939554414, 0.027671188531008983, 0.024351337190828073, 0.021964688397613587, 0.02969774232588103, 0.026040160854750284, 0.03133346852103438, 0.03272493420448054, 0.029938738321303605, 0.03264557249940223]},

        }
    },
    'Oxford dataset': {
        'batches': [0],
        'Ours': {
            0: {'MAE': [0.005042057282844194, 0.004265153808773581, 0.007551669479345941, 0.010433868410267258, 0.003515060816276581, 0.0069755409347703225, 0.008930610841461597, 0.010349136273120044, 0.005379359083181885, 0.008990515608216792],
                'MAPE': [0.006084150289665248, 0.005235778581585951, 0.00523302772171072, 0.008632571326997792, 0.004235830685276292, 0.008240163002500524, 0.005646086958115233, 0.012567378633774435, 0.008687273886126208, 0.008037491176130998],
                'RMSE': [0.00739730335151348, 0.006935158557642184, 0.005402138125324198, 0.013088039295953582, 0.004888590276799513, 0.007539657613004728, 0.00586541650256043, 0.014066973067461085, 0.01911854688746693, 0.008627612069039134]}
        },
        'MLP': {
            0: {'MAE': [0.011355553944673209, 0.013062913393218726, 0.011627373920966605, 0.013065016468818965, 0.04624692831417117, 0.04889507247542787, 0.018385466868267548, 0.01663767482894763, 0.01509619232825681, 0.013939394663003375],
                'MAPE': [0.015027814642289153, 0.016277920950857765, 0.015725233490569437, 0.016122292324031534, 0.05285634953950904, 0.05595199728751892, 0.03818969688490295, 0.03778544903388208, 0.021135416623823497, 0.020451711063745347],
                'RMSE': [0.015027814642289153, 0.016277920950857765, 0.015725233490569437, 0.016122292324031534, 0.05285634953950904, 0.05595199728751892, 0.03818969688490295, 0.03778544903388208, 0.021135416623823497, 0.020451711063745347]}
        },
        'CNN': {
            0: {'MAE':  [0.009337374951525245, 0.01170642285335625, 0.009526621279143012, 0.010782874568239391, 0.004721763629777281, 0.005086625477819299, 0.02301761004784315, 0.021454499185448412, 0.006348100412984231, 0.008681617888934645],
                'MAPE': [0.011007708063791794, 0.013592152516819712, 0.011433177192054639, 0.012655125096394909, 0.005607731310376693, 0.006066102528760898, 0.02686138436376457, 0.02512005929751953, 0.007476558792134069, 0.010008220456672922],
                'RMSE':[0.011600966343075829, 0.01333761446568974, 0.011688967409281792, 0.012172916065271596, 0.006712285418087572, 0.007107526559662006, 0.029927734145233056, 0.029887869378110443, 0.008129234554148651, 0.010342726204122304]}
        },
        'LSTM': { # New model added
            0: {'MAE': [0.009785650955237556, 0.007611169305542853, 0.007333533255422536, 0.006721470174607677, 0.004828676456702961, 0.005572901409718019, 0.01588712762993181, 0.014662708829617828, 0.010323251237354723, 0.010718453950046584],
                'MAPE': [0.011322224947871485, 0.008910657495425115, 0.008521068081960844, 0.007925146666263285, 0.005733365848925232, 0.006564862521895257, 0.0181993847412984, 0.016873703484082132, 0.012673376918202561, 0.013088726560540439],
                'RMSE': [0.01113998828723296, 0.009437280343804613, 0.008904082520019214, 0.008285851668026253, 0.006808576294232704, 0.007392940460515144, 0.025180438419125685, 0.025279133570528182, 0.014504731503633085, 0.014899235309912542]}
        }
    },
    'HUST dataset': {
        'batches': [0],
        'Ours': {
            0: {'MAPE': [0.012192801825190185, 0.01587891348311458, 0.017929362898175667, 0.012058471645833634, 0.011160367096054946, 0.018340864342818782, 0.012497211861927746, 0.021608975471118685, 0.015309954081585397, 0.007536433704154649, 0.008498676457554116, 0.02008894880472866, 0.007240475377237474, 0.013681505842380893, 0.009854895573913822],
                'MAE': [0.010919497756457182, 0.013505555113334965, 0.015050563421840968, 0.010638500479703876, 0.009372530118409906, 0.015972348730551682, 0.010841268471324791, 0.01974458588538429, 0.013043836707995509, 0.006550371468736005, 0.007442259881492081, 0.017408833204989975, 0.006303740761294951, 0.012386149588250689, 0.008401321886482852],
                'RMSE': [0.01319168320201145, 0.018947346972750842, 0.01918077180364281, 0.013795303967506277, 0.01546165600633895, 0.017699304441619733, 0.014456872594151023, 0.023279575499786695, 0.0168253112329674, 0.00921934763932654, 0.009873218782948709, 0.019130642031173255, 0.008967664685566007, 0.014628635552252765, 0.011521342552319977]}
        },
        'MLP': {
            0: {'MAPE': [0.032224802874258655, 0.029551761031398723, 0.014757795064886128, 0.030885900755022153, 0.019297438632837515, 0.021812430817745268, 0.03169163186790156, 0.018412064719346484, 0.02678149376944656, 0.03304361189561683, 0.018908887838403596, 0.03215236728838578, 0.030411625462444098, 0.019650330936948072, 0.01713204688179693],
                'MAE': [0.0367699238932093, 0.028926955033233767, 0.01588687485639559, 0.03614118110533777, 0.02300124869466047, 0.023558092629573372, 0.03790930788640004, 0.02427400856456028, 0.027634764603757727, 0.03985764720205896, 0.0265197668865029, 0.03157578589058022, 0.035163860419720167, 0.021578320960318528, 0.018368172888506524],
                'RMSE': [0.0367699238932093, 0.028926955033233767, 0.01588687485639559, 0.03614118110533777, 0.02300124869466047, 0.023558092629573372, 0.03790930788640004, 0.02427400856456028, 0.027634764603757727, 0.03985764720205896, 0.0265197668865029, 0.03157578589058022, 0.035163860419720167, 0.021578320960318528, 0.018368172888506524]}
        },
        'CNN': {
            0: {'MAPE': [0.029149328269154257, 0.025918887121990655, 0.01732299631867041, 0.02442909935536618, 0.012718173201502064, 0.019272785342653885, 0.03384633344107335, 0.02994877606937807, 0.015857663260041756, 0.026759546307384037, 0.018707950630860743, 0.023708493613097646, 0.027069127606234984, 0.020576383573147786, 0.023816915768903442],
                'MAE': [0.03203426944919068, 0.02536748729032237, 0.017853123961348173, 0.02683905898461563, 0.014681477584537516, 0.019118187925368603, 0.0372727782736485, 0.03046850274132789, 0.016722749397152854, 0.032276474006462594, 0.026873908502729624, 0.02576133120156848, 0.03282274953928708, 0.02395709058272415, 0.022179925558165656],
                'RMSE': [0.03203426944919068, 0.02536748729032237, 0.017853123961348173, 0.02683905898461563, 0.014681477584537516, 0.019118187925368603, 0.0372727782736485, 0.03046850274132789, 0.016722749397152854, 0.032276474006462594, 0.026873908502729624, 0.02576133120156848, 0.03282274953928708, 0.02395709058272415, 0.022179925558165656]}
        },
        'LSTM': { # New model added
            0: {'MAPE': [0.028863109038881233, 0.023232465593130747, 0.02499824862839703, 0.025021239886964405, 0.02465359956561844, 0.025388524484014956, 0.02117330791886932, 0.020142901142239465, 0.014258670759142264, 0.02030512398166735, 0.013448925443154703, 0.020610855578550434, 0.025252839658441616, 0.02249261946331546, 0.02331532978457157],
                'MAE': [0.034085358150585054, 0.029449724324557103, 0.025333024191782266, 0.02761241422228578, 0.02429325947410934, 0.02750137900799724, 0.02464725467576707, 0.021418902606737684, 0.01518557357630771, 0.021798474382236397, 0.015014962698429805, 0.020120821137234193, 0.02757390006424331, 0.022771650359445648, 0.024659056593717806],
                'RMSE': [0.034085358150585054, 0.029449724324557103, 0.025333024191782266, 0.02761241422228578, 0.02429325947410934, 0.02750137900799724, 0.02464725467576707, 0.021418902606737684, 0.01518557357630771, 0.021798474382236397, 0.015014962698429805, 0.020120821137234193, 0.02757390006424331, 0.022771650359445648, 0.024659056593717806]}
        }
    },
    'XJTU batch-1': {
        'batches': [0],
        'Ours': {
            0: {'MAE': [0.006061526778500145, 0.0063929171761632495, 0.011071492668722755, 0.00624386792528327, 0.0035899803937614718, 0.009536816658616873, 0.007224485733771481, 0.012553603262955704, 0.015844902281858485, 0.006683527878288489, 0.006495638673296454, 0.0076990115399263375, 0.011009649008484482, 0.00929085266998059, 0.015990098865664732],
                'MAPE': [0.0032938696040490235, 0.0035110670729844554, 0.006194463571217925, 0.003376206796097738, 0.0019607818556716173, 0.005369475366175337, 0.0039014161236001895, 0.006877058707238613, 0.008631339880475594, 0.0036441609920174114, 0.003582654518311572, 0.0042629028852484326, 0.005887788969504178, 0.0049119805276874665, 0.008694539302877108],
                'RMSE': [0.007618054749942064, 0.008627196302478912, 0.0163389060203349, 0.007732164261382708, 0.005679568306263824, 0.014884618518481501, 0.009358155626328095, 0.015533216595332818, 0.02006759555370344, 0.008786625459757119, 0.009268938426926518, 0.011684421601289132, 0.012337258084460947, 0.010738719895674523, 0.01838645225983029]}
        },
        'MLP': {
            0: {'MAE': [0.023705543042574957, 0.018963186401831335, 0.02858150001448026, 0.05137539048253202, 0.026972928942836295, 0.053762190111640344, 0.05435247996250413, 0.06020198412267875, 0.06070052310398649, 0.04537348003154191, 0.02977951199201578, 0.05680043089795274, 0.014969369341041955, 0.024766315155609488, 0.020871437873970087],
                'MAPE': [0.012967096321801371, 0.010246284629342326, 0.01589099916887352, 0.028045151743352877, 0.014268652153184633, 0.029523600204835777, 0.029388571390083794, 0.04381817674279214, 0.03323442995177229, 0.024814706555170808, 0.015849533257456173, 0.03126595258225768, 0.00811605389964186, 0.013618804418643816, 0.01154785126418649],
                'RMSE': [0.029584587212555406, 0.02332230519122444, 0.041324093386799515, 0.059068150766248, 0.032865553494468, 0.06146940597401964, 0.06032905026651662, 0.06040401280164947, 0.06895617622651387, 0.054666376804764015, 0.03517362879315697, 0.06969642005829452, 0.01921529983828216, 0.03336773521902409, 0.02890600001439026]}
        },
        'CNN': {
            0: {'MAE': [0.03825252194193773, 0.027280236081025467, 0.05437619764302053, 0.021353169115556344, 0.02033879759828401, 0.03334227389381049, 0.033211958063400146, 0.029848100818155393, 0.04650753952208018, 0.05784004223088783, 0.06314239503766191, 0.04512958833798262, 0.032303234031260945, 0.042164363367929225, 0.029575352584423658],
                'MAPE': [0.021143871216840558, 0.014764990278443574, 0.03013767488555876, 0.01155974348630632, 0.010943078041260448, 0.018313426149079732, 0.018303483601916914, 0.016094651942879425, 0.025700858953628933, 0.031513937263275685, 0.04020008108637508, 0.024476191335723253, 0.017392118574313428, 0.02325078328325215, 0.016199015336771642],
                'RMSE': [0.05152359825536148, 0.03226020423531887, 0.0404890794838122, 0.026795924974970745, 0.025164601153835134, 0.04463018517898583, 0.04328698121531014, 0.03579730725450122, 0.0562605767444814, 0.06860360001299766, 0.0604955229515584, 0.05698245284178754, 0.0381372341451459, 0.055679463506226386, 0.038157335269838076]}
        },
        'LSTM': { # New model added
            0: {'MAE': [0.011794315201767424, 0.01313578599850034, 0.015183585880564997, 0.01670352950145477, 0.016975549240982588, 0.01700954293880332, 0.008961374821129105, 0.009470391190097354, 0.01094457312343882, 0.012541620157624, 0.014659769689175562, 0.016237413244182555, 0.015151139763538745, 0.015228557905770082, 0.016162654944828575],
                'MAPE':[0.006317529915887639, 0.007079722235143755, 0.008306787507165759, 0.008971922926719599, 0.009106167991699984, 0.009192339879782463, 0.004869345683249523, 0.005149339743087749, 0.006038679152424246, 0.006726668358852547, 0.007906969691952292, 0.008898724601822325, 0.00808739883984335, 0.008128468265908016, 0.008709692226437752],
                'RMSE': [0.02086413297642301, 0.02346453089363756, 0.02246143189334145, 0.024505852890778786, 0.026457731687140162, 0.0233521632602128, 0.015993486208776775, 0.018156514497691126, 0.01701801703162704, 0.021793693752571456, 0.024665639323895316, 0.023179778946037375, 0.0304238738525889, 0.032786205148636643, 0.028847013538276935]}
        }
    },
    'XJTU batch-2': {
        'batches': [0],
        'Ours': {
            0: {'MAE': [0.014877948067982986, 0.01787916101628235, 0.01277772199312845, 0.017480563123491097, 0.01245460457090644, 0.011439617214600234, 0.01384824182722303, 0.01574857805060873, 0.013852222120761872, 0.01624080569373236, 0.01574993081081176, 0.01163801101048786, 0.014108340153164327, 0.017697777176836002, 0.011433280881245917],
                'MAPE': [0.008089971416942855, 0.009642980707357977, 0.006813189592493512, 0.009653154250419705, 0.006670747946157517, 0.006080506157548775, 0.007506154092702854, 0.008498057020730757, 0.007371793067484801, 0.008823929332498068, 0.00843431716520387, 0.006177399054521762, 0.007617004769984158, 0.009523894106627333, 0.0060675483307096436],
                'RMSE': [0.01948853183975554, 0.023152016652026847, 0.01546174457575504, 0.023150278830235224, 0.016527613982660987, 0.013744546831161315, 0.01693773590694079, 0.020654962747329437, 0.0164775975444161, 0.02140657597855643, 0.020556767299188993, 0.013937487658742679, 0.01837327865255119, 0.022818821071713968, 0.013677949316503428]}
        },
        'MLP': {
            0: {'MAE': [0.04083074933793809, 0.03099746939838658, 0.024746775350968035, 0.014333982270558676, 0.017822971323008634, 0.018911878112951908, 0.037936111388736315, 0.0241178053503806, 0.026162017315626132, 0.017756059705946167, 0.02147198162685104, 0.025347883979479464, 0.025800852663252053, 0.03067203178732202, 0.039152769315242746],
                'MAPE': [0.022432051357714703, 0.016671434457941506, 0.013206768516728012, 0.007801877067704021, 0.009581314863393623, 0.01018817234940893, 0.02099527774738455, 0.013032092073895956, 0.0141343799150176, 0.00972348176535934, 0.011613495926524766, 0.013746028876709507, 0.014229972029783891, 0.016700600444979636, 0.02131970729682323],
                'RMSE':  [0.0453918136668093, 0.03461915093207661, 0.02780693150811252, 0.017535972351316122, 0.022497417232936252, 0.022834601856216406, 0.044000017272115215, 0.028682976908778905, 0.030775604421799437, 0.022419152702043334, 0.027363268050034462, 0.03145519966961199, 0.03303448751052184, 0.039311943756907816, 0.049680424182974435]}
        },
        'CNN': {
            0: {'MAE': [0.0334882891951667, 0.02346124053759212, 0.028721157354116435, 0.055811879853142614, 0.03365944487657986, 0.052446644691626215, 0.03858641073650784, 0.02657700526510297, 0.031975390646855, 0.023260771882798934, 0.03658091045183775, 0.018368654719988487, 0.03327532811694677, 0.055762885130996497, 0.03833667982816695],
                'MAPE':  [0.018441367416477013, 0.012614965271068054, 0.015402731007250928, 0.030693945036030533, 0.01811014499155408, 0.028160723887636643, 0.021269395101391787, 0.014251956417273236, 0.01701818032825669, 0.012531299675605435, 0.019546589614084682, 0.00969591337272385, 0.01790691904818718, 0.029903062939973017, 0.020498997129760964],
                'RMSE': [0.03991831213075682, 0.030608979647284203, 0.03354408873868417, 0.06246282895504094, 0.04443672671160727, 0.056786865494513145, 0.045756421419006835, 0.03529297056655055, 0.03751287138329875, 0.02808646352076545, 0.043094993133753146, 0.022607165119168115, 0.03872599312260741, 0.06730042206107047, 0.044035847413075264]}
        },
        'LSTM': { # New model added
            0: {'MAE':[0.0157224996609158, 0.013706356510264953, 0.019412356815735502, 0.01524448111640084, 0.013416305024349902, 0.016168702274560923, 0.02687552205403645, 0.019813629572432302, 0.013745568060874933, 0.02047549896452161, 0.014424040409638418, 0.011472993957996357, 0.015817797044118245, 0.016010955507423007, 0.021897168157498037],
                'MAPE':[0.008657283708143327, 0.00732418998427579, 0.010420925019140652, 0.008397866807479174, 0.0071374982057308784, 0.00855847468318365, 0.014688230620329428, 0.010537128450261932, 0.007238750188688487, 0.011285530115280608, 0.007736867633473721, 0.006081793483625544, 0.008702902661137447, 0.008569124444369958, 0.011747720032712705],
                'RMSE':[0.02088516796609917, 0.01777354111960217, 0.023248360057188194, 0.02024630295689755, 0.016614464104813157, 0.019566719138662, 0.0328172514383449, 0.02379366502097496, 0.01706343940782618, 0.027018374172073548, 0.018334874384338243, 0.013893880669959115, 0.020583976259516103, 0.01953258264423663, 0.025781035374388247]}
        }
    },
    'XJTU batch-3': {
        'batches': [0],
        'Ours': {
            0: {'MAE': [0.01770972647843183, 0.011262554698520243, 0.01550259961022269, 0.015617788198587298, 0.0025227876432014265, 0.01637676744268399, 0.01654733170900906, 0.006770225173295149, 0.012780313000534517, 0.027444862387635275, 0.02297268745634291, 0.01200650002739642, 0.01689393316758619, 0.008483887913251175, 0.012294730432105775],
                'MAPE':  [0.009503961792803719, 0.005932550819527992, 0.008118688132399568, 0.008302508867497001, 0.0024152469238956243, 0.008611594159524396, 0.008879906245518179, 0.003587980082021119, 0.0067208672654436846, 0.005399729626232683, 0.00259360373046113, 0.007183427677503708, 0.00909882696541275, 0.004455929840736267, 0.0064611713952646525],
                'RMSE': [0.022026084025722713, 0.012557741987145892, 0.018512657918249516, 0.02130250347947333, 0.02582125136621007, 0.019850839802581954, 0.021292215745365804, 0.008431480189064677, 0.017954195179800715, 0.025122418670051678, 0.02519019700667744, 0.01624971058783674, 0.02155434210775198, 0.01001071695764428, 0.01674192307791338]}
        },
        'MLP': {
            0: {'MAE':  [0.06812180373528146, 0.06132191405633485, 0.0608429834529607, 0.02103519784963573, 0.010826501860763085, 0.019808979848418576, 0.01779644895052459, 0.01622243856179593, 0.02382060830280034, 0.016691482821187292, 0.010447449650427295, 0.02071973711553246, 0.0652756204595575, 0.06452668343649974, 0.05070305036294339],
                'MAPE':[0.03717761469817077, 0.032974178609299284, 0.03251733779380196, 0.011370961025995961, 0.005718045578961728, 0.010391681129791427, 0.009462008101562133, 0.008649671852088535, 0.01242721911464608, 0.009009743282915388, 0.005503648318836016, 0.010857229867341032, 0.04100601051235634, 0.03463591645635101, 0.03247517288709766],
                'RMSE': [0.06894697727536089, 0.0675557412211397, 0.06758461481571487, 0.02596307720307812, 0.013019338973775213, 0.022436418062887268, 0.02220546114261087, 0.01889812685605195, 0.025890986452335927, 0.0225042776798737, 0.012745654854336784, 0.023172800546594978, 0.06531915161924826, 0.0705644469371826, 0.06840207784360113]}
        },
        'CNN': {
            0: {'MAE': [0.04984843225888801, 0.06718526869590835, 0.05875809278873481, 0.02708329710831771, 0.03978853109629466, 0.03048547775576815, 0.07345743968079495, 0.043124471807961516, 0.0423111020675813, 0.030768871750388598, 0.047245057231248, 0.05181551883196592, 0.022731964756320642, 0.014836362593101731, 0.020728893361910427],
                'MAPE':[0.026476267629723226, 0.03532885891164105, 0.04600913418495742, 0.014491547621154663, 0.021032806860255524, 0.015817929030634035, 0.06386978412299734, 0.06130315036577421, 0.06664899013998798, 0.01639565239195417, 0.025002012338147077, 0.02707288930311176, 0.012360533541543782, 0.007901093358209472, 0.01092357109633898],
                'RMSE': [0.05820347698660206, 0.07274631452196823, 0.0776712619366606, 0.03689024579303641, 0.04157220860545103, 0.036909494145026034, 0.06101774505054885, 0.056406543930684064, 0.06402137536035928, 0.03538494098385034, 0.04913668087387965, 0.054492067377772416, 0.03075397215980802, 0.017964374399211638, 0.028072077830253738]}
        },
        'LSTM': { # New model added
            0: {'MAE': [0.016622618346542994, 0.010752331536225589, 0.02485196771525373, 0.020011993647336256, 0.009981112037042182, 0.013361383717469493, 0.015730047431740016, 0.015711162653836337, 0.02614284865061441, 0.025296073295257907, 0.0356094097272314, 0.047339798575699935, 0.020482827490502686, 0.009514956406872669, 0.022731954198895087],
                'MAPE':[0.00887715987140791, 0.005732456848366426, 0.012934280958970305, 0.010764859028693938, 0.005287821030136005, 0.007005217875988321, 0.008321525772227256, 0.008389439620765705, 0.01355313984510785, 0.013297733394805751, 0.018935654349909986, 0.024595768084008783, 0.011037177826710882, 0.005030134807001448, 0.011905929875548617],
                'RMSE': [0.01967106189456372, 0.013249238193898694, 0.026660119238441773, 0.024306402649987312, 0.011810684495059013, 0.016112660549491373, 0.019301126973072326, 0.01877849610090757, 0.02887745320545851, 0.031052180151359323, 0.036533125679668044, 0.049875442781532824, 0.023410888821677706, 0.010841463746930638, 0.024780226269443505]}
        }
    }
}

plot_error_violins(test_data, output_file='violin_error_test_2x2.png')
